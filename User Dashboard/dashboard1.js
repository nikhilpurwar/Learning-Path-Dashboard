document.addEventListener("DOMContentLoaded",(()=>{const e=JSON.parse(localStorage.getItem("user"));e&&updateUserProfileDisplay(e)})),async function(){if(!("localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname)&&window.location.pathname.endsWith("dashboard.html"))return void(window.location.href="../index.html?invalid_access=1");const e=localStorage.getItem("authToken");if(e)try{const a=await fetch("../../Backend/check_auth.php",{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!a.ok)throw new Error("Auth check failed");const t=await a.json();if(!t.success)throw new Error("Not authenticated");initDashboard(t)}catch(e){localStorage.removeItem("authToken"),localStorage.removeItem("user"),window.location.href="../index.html?session_expired=1"}else window.location.href="../index.html?auth_required=1"}();const domainTabsContainer=document.querySelector(".domain-tabs"),subjectTabsContainer=document.querySelector(".subject-tabs"),courseGridContainer=document.querySelector(".course-grid"),currentCategorySpan=document.querySelector(".current-category span"),profileIcon=document.querySelector(".profile-icon"),dropdownMenu=document.querySelector(".dropdown-menu");let currentDomain=null,currentSubject=null,courseData={domains:[]},isLoading=!1;async function initDashboard(e){e.user&&(localStorage.setItem("user",JSON.stringify(e.user)),updateUserProfileDisplay(e.user));try{await loadDashboardData(),renderDomainTabs(),setupEventListeners(),courseData.domains.length>0&&setActiveDomain(courseData.domains[0].id)}catch(e){console.error("Dashboard initialization failed:",e),showAlert("Failed to load dashboard data","error")}}function updateUserProfileDisplay(e){if(!e)return;const a=document.querySelector(".profile-name"),t=document.querySelector(".profile-icon");a&&(a.textContent=e.name),e.profile_pic&&t&&(t.innerHTML=`<img src="data:image/png;base64,${e.profile_pic}" alt="Profile Picture" class="user-avatar">`)}function setActiveDomain(e){courseGridContainer.innerHTML='<div class="loading-animation">Loading subjects...</div>',setTimeout((()=>{currentDomain=e,currentSubject=null,document.querySelectorAll(".domain-tab").forEach((a=>{const t=a.dataset.domainId===e;if(a.classList.toggle("active",t),t){const t=courseData.domains.find((a=>a.id===e));a.style.backgroundColor=t.color,a.style.borderColor=t.color,a.style.color="white"}else a.style.backgroundColor="white",a.style.color="var(--deep-space)"})),renderSubjectTabs();const a=courseData.domains.find((a=>a.id===e));currentCategorySpan.textContent=a.name,courseGridContainer.innerHTML='<p class="select-subject-prompt"><i class="fas fa-hand-pointer"></i> Select a subject to view available courses</p>'}),500)}function renderSubjectTabs(){subjectTabsContainer.innerHTML="";const e=courseData.domains.find((e=>e.id===currentDomain));e&&e.subjects.forEach((e=>{const a=document.createElement("button");a.className="subject-tab "+(e.id===currentSubject?"active":""),a.textContent=e.name,a.dataset.subjectId=e.id,a.addEventListener("click",(()=>{setActiveSubject(e.id)})),subjectTabsContainer.appendChild(a)}))}function setActiveSubject(e){courseGridContainer.innerHTML='<div class="loading-animation">Loading courses...</div>',setTimeout((()=>{currentSubject=e,document.querySelectorAll(".subject-tab").forEach((a=>{a.classList.toggle("active",a.dataset.subjectId===e)})),renderCourseGrid()}),800)}function renderCourseGrid(){courseGridContainer.innerHTML="";const e=courseData.domains.find((e=>e.id===currentDomain));if(!e)return;const a=e.subjects.find((e=>e.id===currentSubject));a&&a.courses&&(0!==a.courses.length?(currentCategorySpan.textContent=`${e.name}: ${a.name}`,a.courses.forEach((a=>{const t=document.createElement("div");t.className="course-card",t.innerHTML=`\n        <div class="course-image">\n          <img src="${a.image}" alt="${a.title}">\n          <span class="category-badge" style="background-color: ${e.color}">${e.name}</span>\n        </div>\n        <div class="course-info">\n          <h3 class="course-title">${a.title}</h3>\n          <p class="course-author">By ${a.author}</p>\n          <div class="course-rating">\n            ${renderRatingStars(a.rating)} (${a.reviews} reviews)\n          </div>\n          <div class="course-meta">\n            <div class="course-price">$${a.price.toFixed(2)}</div>\n            <button class="purchase-btn">Enroll Now</button>\n          </div>\n        </div>\n      `;t.querySelector(".purchase-btn").addEventListener("click",(()=>{alert(`Added "${a.title}" to your cart!`)})),courseGridContainer.appendChild(t)}))):courseGridContainer.innerHTML='<p class="no-courses-message"><i class="fas fa-book"></i> No courses available for this subject yet</p>')}function getCurrentDomain(){return courseData.domains.find((e=>e.id===currentDomain))}function transformApiData(e){return e.domains||[]}function renderDomainTabs(){domainTabsContainer.innerHTML="",courseData.domains.forEach((e=>{const a=document.createElement("button");a.className="domain-tab "+(e.id===currentDomain?"active":""),a.innerHTML=`<i class="${e.icon}"></i> ${e.name}`,a.dataset.domainId=e.id,a.style.backgroundColor=e.color,a.style.borderColor=e.color,a.addEventListener("click",(()=>{setActiveDomain(e.id)})),domainTabsContainer.appendChild(a)}))}async function loadDashboardData(){if(!isLoading){isLoading=!0;try{const e=await fetchDashboardData();if(e)return void(courseData.domains=transformApiData(e))}catch(e){console.error("API load failed:",e)}loadFallbackData(),isLoading=!1}}function renderDomainTabs(){domainTabsContainer.innerHTML="",courseData.domains&&0!==courseData.domains.length?courseData.domains.forEach((e=>{const a=document.createElement("button");a.className="domain-tab "+(e.id===currentDomain?"active":""),a.innerHTML=`\n          <i class="${e.icon}"></i>\n          <span>${e.name}</span>\n      `,a.dataset.domainId=e.id,a.style.setProperty("--domain-color",e.color),a.addEventListener("click",(()=>setActiveDomain(e.id))),domainTabsContainer.appendChild(a)})):domainTabsContainer.innerHTML='\n          <div class="empty-state">\n              <i class="fas fa-book-open"></i>\n              <p>No categories available</p>\n          </div>\n      '}async function loadDashboardData(){if(!isLoading){isLoading=!0;try{const e=await fetchDashboardData();if(e)return void(courseData.domains=transformApiData(e))}catch(e){console.error("API load failed:",e)}loadFallbackData(),isLoading=!1}}function loadFallbackData(){courseData.domains=[{id:"web-dev",name:"Web Development",icon:"fas fa-code",color:"#6C5CE7",subjects:[{id:"html-css",name:"HTML & CSS",courses:[{id:"html-fundamentals",title:"HTML Fundamentals",author:"Sarah Johnson",rating:4.5,reviews:128,price:29.99,image:"../../Asset/Courses/html.png",category:"web-dev",progress:parseInt(localStorage.getItem("html-fundamentals-progress"))||0},{id:"css-mastery",title:"CSS Mastery",author:"Mike Chen",rating:4.7,reviews:95,price:39.99,image:"../../Asset/Courses/css.png",category:"web-dev",progress:parseInt(localStorage.getItem("css-mastery-progress"))||0},{id:"responsive-design",title:"Responsive Design",author:"Emma Wilson",rating:4.6,reviews:87,price:34.99,image:"../../Asset/Courses/responsive.png",category:"web-dev",progress:parseInt(localStorage.getItem("responsive-design-progress"))||0}]},{id:"javascript",name:"JavaScript",courses:[{id:"js-basics",title:"JavaScript Basics",author:"Alex Rivera",rating:4.8,reviews:156,price:49.99,image:"../../Asset/Courses/js.png",category:"web-dev",progress:parseInt(localStorage.getItem("js-basics-progress"))||0},{id:"advanced-js",title:"Advanced JavaScript",author:"Priya Patel",rating:4.9,reviews:112,price:59.99,image:"../../Asset/Courses/advanced-js.png",category:"web-dev",progress:parseInt(localStorage.getItem("advanced-js-progress"))||0},{id:"es6-features",title:"ES6 Features",author:"David Kim",rating:4.7,reviews:78,price:44.99,image:"../../Asset/Courses/es6.png",category:"web-dev",progress:parseInt(localStorage.getItem("es6-features-progress"))||0}]}]},{id:"data-science",name:"Data Science",icon:"fas fa-chart-bar",color:"#00CEFF",subjects:[{id:"python-ds",name:"Python for DS",courses:[{id:"python-basics",title:"Python Basics",author:"Raj Patel",rating:4.6,reviews:143,price:34.99,image:"../../Asset/Courses/python.png",category:"data-science",progress:parseInt(localStorage.getItem("python-basics-progress"))||0},{id:"pandas-course",title:"Pandas Mastery",author:"Lisa Wong",rating:4.8,reviews:98,price:49.99,image:"../../Asset/Courses/pandas.png",category:"data-science",progress:parseInt(localStorage.getItem("pandas-course-progress"))||0},{id:"data-visualization",title:"Data Visualization",author:"Carlos Ruiz",rating:4.5,reviews:76,price:39.99,image:"../../Asset/Courses/dataviz.png",category:"data-science",progress:parseInt(localStorage.getItem("data-visualization-progress"))||0}]},{id:"machine-learning",name:"Machine Learning",courses:[{id:"ml-fundamentals",title:"ML Fundamentals",author:"Nadia Ali",rating:4.7,reviews:132,price:59.99,image:"../../Asset/Courses/ml.png",category:"data-science",progress:parseInt(localStorage.getItem("ml-fundamentals-progress"))||0},{id:"tensorflow-course",title:"TensorFlow Basics",author:"James Wilson",rating:4.6,reviews:88,price:54.99,image:"../../Asset/Courses/tensorflow.png",category:"data-science",progress:parseInt(localStorage.getItem("tensorflow-course-progress"))||0},{id:"nlp-intro",title:"NLP Introduction",author:"Sophia Chen",rating:4.9,reviews:67,price:49.99,image:"../../Asset/Courses/nlp.png",category:"data-science",progress:parseInt(localStorage.getItem("nlp-intro-progress"))||0}]}]},{id:"mobile-dev",name:"Mobile Development",icon:"fas fa-mobile-alt",color:"#FD79A8",subjects:[{id:"flutter",name:"Flutter",courses:[{id:"flutter-basics",title:"Flutter Basics",author:"Thomas Baker",rating:4.6,reviews:121,price:49.99,image:"../../Asset/Courses/flutter.png",category:"mobile-dev",progress:parseInt(localStorage.getItem("flutter-basics-progress"))||0},{id:"flutter-ui",title:"Flutter UI Design",author:"Maria Garcia",rating:4.8,reviews:94,price:54.99,image:"../../Asset/Courses/flutter-ui.png",category:"mobile-dev",progress:parseInt(localStorage.getItem("flutter-ui-progress"))||0},{id:"flutter-firebase",title:"Flutter with Firebase",author:"Kevin Lee",rating:4.7,reviews:78,price:59.99,image:"../../Asset/Courses/flutter-firebase.png",category:"mobile-dev",progress:parseInt(localStorage.getItem("flutter-firebase-progress"))||0}]},{id:"react-native",name:"React Native",courses:[{id:"rn-basics",title:"React Native Basics",author:"Emma Johnson",rating:4.5,reviews:112,price:44.99,image:"../../Asset/Courses/react-native.png",category:"mobile-dev",progress:parseInt(localStorage.getItem("rn-basics-progress"))||0},{id:"rn-advanced",title:"Advanced React Native",author:"Daniel Kim",rating:4.7,reviews:86,price:54.99,image:"../../Asset/Courses/rn-advanced.png",category:"mobile-dev",progress:parseInt(localStorage.getItem("rn-advanced-progress"))||0},{id:"rn-performance",title:"RN Performance",author:"Sophie Martin",rating:4.6,reviews:64,price:49.99,image:"../../Asset/Courses/rn-performance.png",category:"mobile-dev",progress:parseInt(localStorage.getItem("rn-performance-progress"))||0}]}]}]}async function handleCourseAction(e,a){const t=document.querySelectorAll(".purchase-btn"),r=Array.from(t).find((a=>a.closest(".course-card").querySelector("img").alt.includes(e)));if(!r)return;const s=r.innerHTML;r.disabled=!0,r.innerHTML='<i class="fas fa-spinner fa-spin"></i> Processing...';try{const t=localStorage.getItem("authToken");if(!t)throw new Error("Not authenticated");const r=await fetch("../../Backend/enroll.php",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({courseId:e,isContinue:a?1:0})});if(!r.ok)throw new Error("Request failed");const s=await r.json();if(!s.success)throw new Error(s.message||"Action failed");showAlert(`Course ${a?"continued":"enrolled"} successfully!`,"success"),await loadDashboardData()}catch(e){console.error("Action failed:",e),showAlert(e.message||"Action failed. Please try again.","error")}finally{r.disabled=!1,r.innerHTML=s}}function renderRatingStars(e){const a=Math.floor(e),t=e%1>=.5,r=5-a-(t?1:0);let s="";return s+='<i class="fas fa-star"></i>'.repeat(a),t&&(s+='<i class="fas fa-star-half-alt"></i>'),s+='<i class="far fa-star"></i>'.repeat(r),s}function showAlert(e,a="success"){const t=document.createElement("div");t.className=`alert alert-${a}`,t.setAttribute("role","alert"),t.innerHTML=`\n      <i class="fas fa-${"success"===a?"check-circle":"exclamation-circle"}"></i>\n      ${e}\n  `,document.body.appendChild(t),setTimeout((()=>t.remove()),5e3)}function setupEventListeners(){profileIcon?.addEventListener("click",(e=>{e.stopPropagation(),dropdownMenu?.classList.toggle("show")})),document.addEventListener("click",(()=>{dropdownMenu?.classList.remove("show")}))}